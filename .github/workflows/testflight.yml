name: Build & Deploy to TestFlight

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: testflight-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: macos-26
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26'

      - name: Show build environment
        run: |
          xcodebuild -version
          swift --version
          xcode-select -p

      - name: Install App Store Connect API key
        env:
          API_KEY_BASE64: ${{ secrets.ASC_API_KEY_BASE64 }}
          API_KEY_ID: ${{ secrets.ASC_API_KEY_ID }}
        run: |
          mkdir -p ~/private_keys
          echo "$API_KEY_BASE64" | base64 --decode > ~/private_keys/AuthKey_${API_KEY_ID}.p8

      - name: Increment build number
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          agvtool new-version -all $BUILD_NUMBER

      - name: Build (compile check)
        run: |
          xcodebuild build \
            -project Leona.xcodeproj \
            -scheme Leona \
            -destination "generic/platform=iOS" \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${{ secrets.ASC_API_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.ASC_API_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.ASC_API_ISSUER_ID }} \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM=HLUMLG6SWA \
            CODE_SIGNING_ALLOWED=NO

      - name: List signing identities
        run: |
          echo "=== Signing identities ==="
          security find-identity -v -p codesigning
          echo "=== Provisioning profiles ==="
          ls ~/Library/MobileDevice/Provisioning\ Profiles/ 2>/dev/null || echo "No profiles"
          echo "=== API Key file ==="
          ls -la ~/private_keys/

      - name: Archive
        id: archive
        continue-on-error: true
        run: |
          xcodebuild archive \
            -project Leona.xcodeproj \
            -scheme Leona \
            -destination "generic/platform=iOS" \
            -archivePath $RUNNER_TEMP/Leona.xcarchive \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${{ secrets.ASC_API_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.ASC_API_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.ASC_API_ISSUER_ID }} \
            CODE_SIGN_STYLE=Automatic \
            DEVELOPMENT_TEAM=HLUMLG6SWA \
            2>&1 | tee /tmp/archive_output.txt

      - name: Check archive result
        if: steps.archive.outcome == 'failure'
        run: |
          echo "Archive failed! Last 50 lines:"
          tail -50 /tmp/archive_output.txt
          echo "---"
          echo "Error lines:"
          grep -i "error" /tmp/archive_output.txt || echo "None found"
          exit 1

      - name: Report archive error
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let errorContent = 'No error file found';
            try {
              errorContent = fs.readFileSync('/tmp/archive_output.txt', 'utf8');
              // Only keep last 3000 chars to fit in issue body
              if (errorContent.length > 3000) {
                errorContent = '...\n' + errorContent.slice(-3000);
              }
            } catch (e) {
              errorContent = `Error reading file: ${e.message}`;
            }
            const title = `CI Build ${context.runNumber}: archive failed`;
            const body = `## Archive Error Output\n\`\`\`\n${errorContent}\n\`\`\`\n\nCommit: ${context.sha}\nRun: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body
            });

      - name: Export and Upload to TestFlight
        run: |
          cat > $RUNNER_TEMP/ExportOptions.plist << 'PLIST'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store-connect</string>
              <key>destination</key>
              <string>upload</string>
              <key>signingStyle</key>
              <string>automatic</string>
              <key>teamID</key>
              <string>HLUMLG6SWA</string>
              <key>uploadSymbols</key>
              <true/>
          </dict>
          </plist>
          PLIST

          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/Leona.xcarchive \
            -exportPath $RUNNER_TEMP/export \
            -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist \
            -allowProvisioningUpdates \
            -authenticationKeyPath ~/private_keys/AuthKey_${{ secrets.ASC_API_KEY_ID }}.p8 \
            -authenticationKeyID ${{ secrets.ASC_API_KEY_ID }} \
            -authenticationKeyIssuerID ${{ secrets.ASC_API_ISSUER_ID }}
